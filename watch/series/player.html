<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Anime</title>
    <link href="https://vjs.zencdn.net/8.16.1/video-js.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="https://thefarawaydev.github.io/better-anime/watch/other/BA.png">
</head>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    :root {
    --cadet-gray: #8fa3bb;
    --bleu-de-france: #4a88d7;
    --charcoal: #3a4f63;
    --white: #ffffff;
    --steel-blue: #4b7db9;
    --light-gray: #f0f0f0;
    --light-green: #3f8394;
    --light-red: #d05656;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        font-family: 'Roboto', sans-serif;
        background-color: #2b3e50;
        scrollbar-width: none; /* For Firefox */
    }

    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        background-color: #2b3e50;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        overflow: hidden;
        padding-bottom: 20px;
        scrollbar-width: none;
    }

    header {
        padding: 1rem 5rem;
        background-color: var(--bleu-de-france) ;
        color: #000000;
        display: flex;
        width: 100%;
        height: 25px;
        margin-left: 150px;
        margin-bottom: 20px;
    }

    .logo a {
        color: #fff;
        font-size: 1.5rem;
        text-decoration: none;
        font-weight: bold;
        margin-left: 2.5vw;
    }

    .logo a:hover {
    color: #225186;
    }

    .content {
        flex-direction: column; 
        align-items: center;
    }

    .video-js {
        width: 85%;
        height: 490px;
        background-color: #3c4a5a;
        margin-bottom: 10px;
    }

    .button-container {
        display: flex;
        flex-direction: column;
        width: 86%;
        margin: 10px 0;
        text-align: center;
    }

    .toggle-options, .season-selector, .setting-options {
        display: flex;
        justify-content: center;
        margin: 2px 0;
        flex-wrap: wrap;
    }

    .toggle-options button, .season-selector button, .setting-options button {
        background-color: #3c6eb3;
        color: white;
        border: none;
        padding: 10px 10px;
        margin: 5px;
        cursor: pointer;
        font-size: 16px;
        flex: 1;
        transition: background-color 0.3s, transform 0.2s;
        flex: 1 1 calc(33.33% - 10px);
        border-radius: 4px;
    }

    .toggle-options button:hover, .season-selector button:hover, .setting-options button:hover {
        background-color: #5a9cec;
        transform: scale(1.05);
    }

    .toggle-options button.active, .season-selector button.active, .setting-options button.active {
        background-color: #4A90E2;
    }

    .episode-container {
        display: flex;
        justify-content: center;
        overflow-y: auto;
        height: 200px;
        width: 83%;
        border: 1px solid #799ec2;
        background-color: #537196;
        padding: 10px;
        scrollbar-width: none;
        border-radius: 4px;
    }

    .episode-list {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .episode-list button {
        background-color: #34495E;
        color: white;
        border: none;
        padding: 10px;
        margin: 5px;
        width: 90%;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s, transform 0.2s;
    }

    .episode-list button:hover {
        background-color: #5a6b7c;
        transform: scale(1.05);
    }

    .episode-list button.active {
        background-color: #5a6b7c;
        color: #2b3e50;
    }

    @media screen and (min-width: 769px) and (max-width: 1024px) {     
        header {
            margin-left: 75px;
            padding: 1rem 5rem;
        }
    }


    @media screen and (max-width: 768px) {
        .container {
            width: 85%;
            border-radius: 10px;
            border: 2px solid #000000;
        }

        .video-js {
            width: 93%;
            height: 260px;
        }

        header {
            margin-left: 10px;
            border-bottom: 2px solid #000000;
        }

        .episode-container {
            width: 87%;
            height: 150px;
        }

        .button-container {
            width: 95%;
        }
        
        .season-selector button {
            font-size: 14px;
            text-align: center;
            width: 10%;
        }  

        .toggle-options, .season-selector, .setting-options {
            flex-wrap: wrap;
        }

        .toggle-options button, .season-selector button, .setting-options button {
            flex: 1 1 calc(33.33% - 10px);
        }

        div[aria-live="polite"] {
            display: none !important;
        }
    }
</style>
<body>
    <div class="container">
        <header>
            <div class="logo"><a href="https://thefarawaydev.github.io/better-anime/home">Better Anime</a></div>
        </header>

        <div class="content"></div>
            <video id="my-video" class="video-js" controls preload="none" 
                poster="https://thefarawaydev.github.io/better-anime/watch/other/BA.png"
                data-setup='' playsinline>
            <source id="video-source" src="https://example.mp4" type="video/mp4" />
            </video>

            <div class="button-container">
            <div class="toggle-options">
                <button onclick="toggleLanguage('sub')" id="subButton">Subbed</button>
                <button onclick="toggleLanguage('dub')" id="dubButton">Dubbed</button>
            </div>
            </div>

            <div class="episode-container">
            <div class="episode-list" id="episode-list">
                <!-- Episodes will be dynamically added here -->
            </div>
            </div>
        </div>
        </div>

        <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
        <script>
            const animePlayer = videojs('my-video');
            const serverButtonsContainer = document.querySelector('.toggle-options');
            const episodeListContainer = document.querySelector('.episode-list');
    
            const apiUrlBase = 'https://better-anime.vercel.app';
            const proxyUrl = 'https://better-m3u8-proxy.vercel.app/m3u8-proxy?url=';
            const proxyHeaders = '&headers={%22referer%22:%20%22https://megacloud.club/%22}';
    
            const urlParams = new URLSearchParams(window.location.search);
            const currentAnimeId = urlParams.get('id'); // Pull the anime ID from the URL parameters
            const currentSeriesName = urlParams.get('series'); // Get the series name
            let currentEpisodeId = null;
            let currentEpisodeTitle = null;
            let currentCategory = localStorage.getItem('preferredCategory') || 'sub';
    
            // Function to fetch anime episodes
            async function fetchAnimeEpisodes(animeId) {
                try {
                    const response = await fetch(`${apiUrlBase}/api/v2/hianime/anime/${animeId}/episodes`);
                    const data = await response.json();
                    if (data.success && data.data && data.data.episodes) {
                        displayEpisodes(data.data.episodes);
                    } else {
                        alert('Could not load episodes.');
                    }
                } catch (error) {
                    console.error('Error fetching episodes:', error);
                    alert('Error loading episodes.');
                }
            }
    
            // Function to display the list of episodes
            function displayEpisodes(episodes) {
                episodeListContainer.innerHTML = ''; // Clear existing episodes
                episodes.forEach(episode => {
                    const button = document.createElement('button');
                    button.textContent = `Episode ${episode.number}: ${episode.title}`;
                    button.dataset.url = episode.url; // Add data-url attribute
                    button.dataset.episodeId = episode.episodeId; // Add data-episodeId attribute
                    button.dataset.episodeTitle = episode.title; // Add data-episodeTitle attribute
                    button.addEventListener('click', () => {
                        loadEpisodeServers(episode.episodeId, episode.title);
                        highlightCurrentEpisode(button);
                    });
                    episodeListContainer.appendChild(button);
    
                    // No need to check localStorage.getItem('currentEpisodeUrl') here anymore
                });
            }
    
            // Function to highlight the current episode
            function highlightCurrentEpisode(selectedButton) {
                document.querySelectorAll('.episode-list button').forEach(button => button.classList.remove('active'));
                selectedButton.classList.add('active');
            }
    
            // Function to load available servers for an episode
            async function loadEpisodeServers(episodeId, episodeTitle) {
                currentEpisodeId = episodeId;
                currentEpisodeTitle = episodeTitle;
                localStorage.setItem('lastWatchedEpisodeId_' + currentAnimeId, episodeId); // Save the ID
                localStorage.setItem('lastWatchedEpisodeTitle_' + currentAnimeId, episodeTitle); // Save the title
                loadStreamingLinks(episodeId, currentCategory);
            }
    
            // Function to fetch and play streaming links
            async function loadStreamingLinks(episodeId, category) {
                try {
                    const response = await fetch(`${apiUrlBase}/api/v2/hianime/episode/sources?animeEpisodeId=${episodeId}&server=hd-2&category=${category}`);
                    const data = await response.json();
    
                    if (data.success && data.data && data.data.sources && data.data.sources.length > 0) {
                        const videoUrl = data.data.sources[0].url;
                        const savedTime = loadProgress(episodeId, currentEpisodeTitle);
                        playVideo(videoUrl, savedTime);
                    } else {
                        // Try with hd-1 if hd-2 fails
                        const responseHd1 = await fetch(`${apiUrlBase}/api/v2/hianime/episode/sources?animeEpisodeId=${episodeId}&server=hd-1&category=${category}`);
                        const dataHd1 = await responseHd1.json();
                        if (dataHd1.success && dataHd1.data && dataHd1.data.sources && dataHd1.data.sources.length > 0) {
                            const videoUrl = dataHd1.data.sources[0].url;
                            const savedTime = loadProgress(episodeId, currentEpisodeTitle);
                            playVideo(videoUrl, savedTime);
                        } else {
                            animePlayer.reset();
                            animePlayer.src({ type: 'application/x-mpegURL', src: '' });
                            alert(`No ${category} streams found for this episode.`);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching streaming links:', error);
                    animePlayer.reset();
                    animePlayer.src({ type: 'application/x-mpegURL', src: '' });
                    alert(`Error loading ${category} stream.`);
                }
            }
    
            // Function to save the watch progress of each episode
            function saveProgress(videoUrl, currentTime) {
                if (!currentAnimeId || !currentEpisodeId || !currentEpisodeTitle) {
                    return; // Don't save if we don't have the necessary info
                }
                const progressKey = `watchProgress_${currentAnimeId}_${currentEpisodeId}_${currentEpisodeTitle.replace(/[^a-zA-Z0-9]/g, '_')}`; // Create a unique key
                console.log("Saving progress for key:", progressKey, "at time:", currentTime);
                localStorage.setItem(progressKey, currentTime);
            }

            function loadProgress(episodeId, episodeTitle) {
                if (!currentAnimeId || !episodeId || !episodeTitle) {
                    return 0;
                }
                const progressKey = `watchProgress_${currentAnimeId}_${episodeId}_${episodeTitle.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const savedTime = localStorage.getItem(progressKey);
                console.log("Loading progress for key:", progressKey, "found time:", savedTime);
                return savedTime ? parseFloat(savedTime) : 0;
            }
    
            // Function to auto-load the last watched episode and its progress
            function loadLastWatchedEpisode() {
                const lastWatchedEpisodeId = localStorage.getItem('lastWatchedEpisodeId_' + currentAnimeId);
                const lastWatchedEpisodeTitle = localStorage.getItem('lastWatchedEpisodeTitle_' + currentAnimeId);
    
                if (lastWatchedEpisodeId && lastWatchedEpisodeTitle) {
                    const episodeButton = Array.from(document.querySelectorAll('.episode-list button')).find(
                        button => button.dataset.episodeId === lastWatchedEpisodeId
                    );
    
                    if (episodeButton) {
                        console.log("Last watched episode button found (by ID):", episodeButton);
                        highlightCurrentEpisode(episodeButton);
                        loadEpisodeServers(lastWatchedEpisodeId, lastWatchedEpisodeTitle); // Set currentEpisodeId and title
                        const savedTime = loadProgress(lastWatchedEpisodeId, lastWatchedEpisodeTitle);
                        loadStreamingLinks(lastWatchedEpisodeId, currentCategory); // This will now use loadProgress
                    } else {
                        console.log("Could not find last watched episode button (by ID).");
                        // Maybe try to load the first episode or do nothing
                    }
                } else {
                    console.log("No last watched episode ID saved for this anime.");
                }
            }
    
            // Function to play the video with progress
            function playVideo(videoUrl, startTime = 0) {
                animePlayer.reset();
                animePlayer.src({ type: 'application/x-mpegURL', src: proxyUrl + videoUrl + proxyHeaders});
                animePlayer.ready(() => {
                    animePlayer.currentTime(startTime);
                    animePlayer.play();
                });
            }
    
            // Event listener to save progress periodically
            animePlayer.on('timeupdate', () => {
                saveProgress(animePlayer.currentSrc(), animePlayer.currentTime());
            });
    
            // Function to save the series ID for the continue watching page
            function saveToContinueWatching(id, title, url) {
                let continueWatchingArray = JSON.parse(localStorage.getItem('continueWatching')) || [];
                const existingItemIndex = continueWatchingArray.findIndex(item => item.id === id);
                const pageUrl = window.location.href;
    
                if (existingItemIndex !== -1) {
                    continueWatchingArray[existingItemIndex].url = pageUrl;
                } else {
                    continueWatchingArray.push({ id, title, url: pageUrl });
                }
    
                localStorage.setItem('continueWatching', JSON.stringify(continueWatchingArray));
            }
    
            // Function to update button styles
            function updateButtonStyles(containerClass, activeId) {
                document.querySelectorAll(`.${containerClass} button`).forEach(button => {
                    button.classList.remove('active');
                });
                const activeButton = document.getElementById(activeId + 'Button');
                if (activeButton) activeButton.classList.add('active');
            }
    
            // Function to toggle language and highlight button
            function toggleLanguage(category) {
                currentCategory = category;
                localStorage.setItem('preferredCategory', currentCategory);
                updateButtonStyles('toggle-options', category);
                if (currentEpisodeId) {
                    loadStreamingLinks(currentEpisodeId, currentCategory);
                }
            }
    
            // Event listeners for server buttons
            serverButtonsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('server-button')) {
                    updateButtonStyles('toggle-options', event.target.dataset.category);
                    currentCategory = event.target.dataset.category;
                    localStorage.setItem('preferredCategory', currentCategory);
                    if (currentEpisodeId) {
                        loadStreamingLinks(currentEpisodeId, currentCategory);
                    }
                }
            });
    
            // Get the anime ID when the page loads
            document.addEventListener('DOMContentLoaded', () => {
                if (currentAnimeId) {
                    fetchAnimeEpisodes(currentAnimeId).then(() => {
                        loadLastWatchedEpisode(); // Load the last watched episode after fetching episodes
                    });
                    saveToContinueWatching(currentAnimeId, 'Anime Title', window.location.href); // Replace 'Anime Title' with the actual title
                }
                // Auto-select preferred category or default to 'sub'
                updateButtonStyles('toggle-options', currentCategory);
                // We don't need to load streaming links here initially, loadLastWatchedEpisode will handle it
            });
        </script>
</body>
</html>